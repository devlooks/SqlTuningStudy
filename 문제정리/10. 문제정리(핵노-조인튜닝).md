
# SQL Server Hint 및 조인 전략

## 기본 힌트 구문
```sql
FROM ~
WHERE ~
OPTION (
  -- 나열 순 조인
  FORCE ORDER,

  -- NL 조인 유도
  LOOP JOIN,
  INNER LOOP JOIN,

  -- Hash 조인 유도
  INNER HASH JOIN
)
```

---

## NL 조인
- 랜덤 액세스 위주 조인 방식  
- 순차적 진행 → 부분 처리 가능 → 빠른 응답속도  
- 먼저 액세스 테이블 처리 범위가 전체 일량 결정  
- 조인 컬럼 유무 → 조인 효율 상승  
- 소량 데이터 혹은 OLTP 시스템에 적합

---

## 소트 	생략
- `ORDER BY` 컬럼 → 인덱스 후행 컬럼으로 배치  
- 여러 컬럼일 경우, 묶어서 인덱스 구성 필요

---

## Prefetch I/O 실행 계획
- 후순위 테이블 먼저 처리

---

## Batched I/O 실행 계획
- 후순위 테이블을 마지막에 처리

---

## 소트 머지 조인 특징
- NL 조인처럼 개별적으로 읽고, 양쪽 정렬 (PGA) 후 조인  
- 소트 부하 감수 필요 (NL보다 빠를 수 있음)  
- 인덱스 유무 무관  
- 랜덤 액세스 사용 (해시 조인도 동일)  
- PGA에서 처리 → Latch 불필요  
- TEMP 테이블 스페이스 사용량 ↑  
- 등치 조건 아님도 가능  
- 일반적으로 해시 조인이 더 빠름

---

## 해시 조인 특징
- 해시 맵 생성 (Build Input) / 탐색 (Probe Input)  
- 적은 테이블 → Build / 큰 테이블 → Probe  
- PGA 내에서 해시 처리  
- 인덱스 유무 무관  
- Build Input 크기가 PGA 이하일수록 효율적  
- 등치 조건 중 하나 이상 있어야 적용 가능  
- PGA 사용 Latch 사용 안함

---

## 조인별 유리한 점

- **NL 조인**
  - 드라이빙 집합에 따라 전체 작업량 결정
  - 일반적으로 작은 집합 유리, 인덱스 구성에 따라 큰 집합도 가능

- **Hash 조인**
  - 작은 쪽 테이블 드라이빙 유리

- **Sort Merge 조인**
  - 조인 순서 영향 적음
  - 성능 차이 크지 않음

---

## Join 입력 설정 힌트

- `LEADING`, `ORDERED` → 첫 번째 테이블 Build Input 지정  
- Build Input 선정: `SWAP_JOIN_INPUTS()`  
- Probe Input 선정: `NO_SWAP_JOIN_INPUTS()`

---

## 스칼라 서브쿼리 변환 전략

- 스칼라 서브쿼리 → 일반 조인문 변환  
  - 성능상 Outer보다 Inner 처리 유리 (결과 집합은 동일)  

- 일반 조인문 → 스칼라 서브쿼리로 변환 가능  
  - 필수/옵션 관계와 무관  
  - Outer 조인과 유사한 결과

---

## 스칼라 서브쿼리 캐싱 효과

- 입력값/출력값 → Query Execution Cache 저장  
- 캐싱 메모리: `_query_execution_cache_max_size`  
- 해시 충돌 적고, return 값 적을수록 효과↑

- 실행 계획에서 서브쿼리 먼저 처리, 메인 쿼리 바로 아래 위치

---

## 조인 조건 Push Down

- 목적: 뷰 외부 조건절 활용  
- 뷰 + 메인 쿼리 → Merging (부분 처리 X)  
- Push Down 사용 시 → 부분 처리 가능  
- 실행계획: `VIEW PUSHED PREDICATE`

- 사용 힌트 예시:
```sql
-- 메인
/*+ ORDERED USE_NL(t) */

-- 서브쿼리
/*+ NO_MERGE PUSH_PRED */

-- 통합형
/*+ ORDERED USE_NL(t) NO_MERGE(t) PUSH_PRED(t) */
```

---

## 결과 집합 비율 기준

- 결과 집합 10% 이상: `USE_HASH`, Full Scan  
- 결과 집합 10% 이하: `USE_NL`

---

## 스칼라 쿼리 Unnesting
- 부분 처리 가능성 향상

---

## NO_MERGE 무효 케이스
- `ROWNUM` 사용  
- `GROUP BY + ORDER BY` 조합 사용 시

---

## 인라인 뷰 Full Scan
- 인라인 뷰 내부에서 이미 Full 사용 → 메인에서 Full 힌트 무의미

---

## ROWNUM + USE_NL 조합

- 인라인 뷰에 따라 Full Scan 발생 가능  
- `Batched I/O` 발생, 순서 변경 가능성 있음  
- 마지막 정렬 위해 `ORDER BY`, `NO_NLJ_BATCHING` 사용 권장 (서브쿼리 아닌 테이블 대상)

---

## 인덱스 정렬 힌트

- `INDEX_DESC`: `ORDER BY DESC`와 함께 사용 → 정렬 생략 가능  
- `INDEX`: `ORDER BY ASC`와 함께 사용 → 정렬 생략 가능
