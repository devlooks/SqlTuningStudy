
# SQL 분석 도구

## 예상 실행계획

실행계획  
- `EXPLAIN PLAN FOR` → SQL*Plus  
- `SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY_CURSOR(sql_id, childnumber, '{option}'))` → Oracle  
- `SET SHOWPLAN_TEXT ON` → SQL Server

DBMS_XPLAN.DISPLAY ~ 트레이스 내용  
- 오브젝트 엑세스 방식  
- 오브젝트 명  
- 예상 Cardinality (=Rows)  
- 예상 데이터 크기 (=Bytes)  
- 예상 CPU Time  
- 조건절 종류

**Autotrace 제공 정보**  
- 예상 실행 계획  
- 재귀 Call  
- Physical Reads ⇒ 실제 디스크에서 읽은 블록  
- Redo Size ⇒ 실제 기록된 Redo 크기

```sql
SET AUTOTRACE ON
  → SQL 실행, 결과집합, 예상 실행 계획, 실행계획 출력

SET AUTOTRACE ON EXPLAIN
  → SQL 실행, 결과집합, 예상 실행 계획

SET AUTOTRACE ON STATISTICS
  → SQL 실행, 결과집합, 실행 통계

SET AUTOTRACE TRACEONLY
  → SQL 실행, 결과집합X, 예상 실행 계획, 실행 통계

SET AUTOTRACE TRACEONLY EXPLAIN
  → SQL 실행 X, 예상 실행 계획만 출력

SET AUTOTRACE TRACEONLY STATISTICS
  → SQL 실행 O, 결과 출력 X, 실행 통계만 출력
```

- `STATISTICS_LEVEL` 파라미터: `ALL` 설정 시 SQL 트레이스 메모리 저장  
- `GATHER_PLAN_STATISTICS` → 옵티마이저 힌트

## SQL 트레이스

**TKProf 유틸리티**  
- SQL 트레이스 파일 분석 및 리포트 생성  
```bash
tkprof oralog_ora_1430_oraking.trc report.prf sys=no
```

**오라클 SQL 트레이스 형식**
```
call     count    cpu    elapsed    disk    query  current  rows
Parse      1       ...    ...        ...     ...     ...     ...
Execute    1       ...    ...        ...     ...     ...     ...
Fetch      2       ...    ...        ...     ...     ...     ...
Total      4       ...    ...        ...     ...     ...     ...

Misses in library cache during parse : 1  
Optimizer mode : ALL_ROWS  
Parsing user id : 61

Rows  Row Source Operation  
  1    TABLE ACCESS (cr=~~ pr=~~)  
  1      INDEX RANGE SCAN (cr=~~ pr=~~)  
```

- Auto Trace의 Recursive Call ⇒ 하드파싱 시 내장 함수 SQL 수행 시 발생하는 Call 수

**DBMS_XPLAN.DISPLAY_CURSOR 함수**  
- 옵션: `sql_id`, `child_number`, ...  
- `(NULL, NULL, ...)` → 최근 수행된 SQL 계획 출력  

**MONITOR 힌트**  
- 실시간 SQL 모니터링 리포트 생성  
- `DBMS_SQLTUNE.REPORT_SQL_MONITOR` 사용

**DBMS_XPLAN.DISPLAY_CURSOR 주요 항목**

| 항목      | 의미                                |
|-----------|-------------------------------------|
| Starts    | 오퍼레이션 단계별 실행 횟수         |
| E-Rows    | 예상 Rows                           |
| A-Rows    | 실제 처리 Rows                      |
| A-Times   | 단계별 소요 시간                    |
| Buffers   | 캐시에서 읽은 버퍼 수               |
| Reads     | 디스크에서 읽은 블록 수             |

```
DBMS_XPLAN     SQL 트레이스
A-Rows         rows
A-Times        time
Buffers        cr (= query, current)
Reads          pr
```

**SQL Server 트레이스 옵션**
- `SET STATISTICS PROFILE ON` : 쿼리 실행 프로필  
- `SET STATISTICS IO ON`      : 디스크 작업량  
- `SET STATISTICS TIME ON`    : 컴파일 및 실행 시간

## 응답 시간 분석

**대기 이벤트 발생 케이스**
- 래치 획득 중 경합 발생
- CPU를 OS에 반환하여 Sleep 상태 전환 ⇒ Wait 이벤트 발생
- Sleep 상태 전환 원인:
  1. 필요한 리소스를 다른 프로세스가 사용 중  
  2. 작업 완료까지 대기 중  
  3. 프로세스가 할 일이 없음

**대표 대기 이벤트**
- `latch: shared pool` : 하드파싱이 동시에 심할 때 발생  
- `library cache lock / pin` : SQL 수행 중 DDL 발생 시  
- `free buffer waits` : Free Buffer를 찾지 못하고 DBWR에게 공간 확보 요청 후 대기  
- `log file sync` : LGWR에게 로그버퍼를 로그파일에 기록 요청 후 대기

**대기 이벤트 기반 성능 관리 방법론**
- 시스템 전체 기준 병목 및 원인 파악  
- **OWI**: Response Time Analysis 방법론 지원 도구  
- **AWR**: 성능 데이터 주기적 수집  
  - Ratio 기반 분석 + 대기 이벤트 기반 분석

**응답 시간 공식**  
```
Response Time = Service Time + Wait Time  
              = CPU Time + Queue Time
```

**Statspack**  
- Ratio 기반 + 응답 시간 기반 성능 분석 방법론

**AWR** (Statspack 업그레이드)  
- 피크 시간대, 장애 발생 시점 등 분석  
- DMA 방식으로 SGA 직접 접근 → 빠른 정보 수집

**AWR 보고서 요약 항목**
- 캐시 크기  
- 부하 프로파일  
- 인스턴스 효율성  
- 최상위 대기 이벤트  
- Shared Pool 통계  
- I/O 프로파일  
- 메모리 통계

**인스턴스 SQL 효율성 지표**
- **Soft Parse %**: 하드파싱 없이 SQL 수행 비율  
  ```sql
  (전체 Parse Call 회수 - 하드파싱 회수) / 전체 Parse Call * 100
  ```

- **Execute to Parse %**: Parse 없이 반복 SQL 수행 비율  
- **Parse CPU to Parse Elapsed %**: 파싱 소요 시간 중 CPU Time 비율 (낮을수록 대기 많음)

## 기타 분석 도구

**ASH (Active Session History)**  
- `V$ACTIVE_SESSION_HISTORY` 뷰 제공  
- 1초마다 샘플링, SGA 내 버퍼 저장  
- CPU당 약 2MB Shared Pool 버퍼 할당

**RAT (Real Application Testing)**  
- DB 구조 변경, 업그레이드 등 영향 평가

**SPA (SQL Performance Analyzer)**  
- DB 변경에 따른 SQL 실행 계획 변화 분석

**관련 뷰**
- `V$SESSION_WAIT` : 대기 이벤트 발생 세션 확인  
- `V$ACTIVE_SESSION_HISTORY` : 세션별 SQL 수행 추적  
- `V$SQL` : SQL 문장과 통계 (실행 횟수, 평균 시간 등)  
- `DBA_HIST_ACTIVE_SESS_HISTORY` : 과거 세션 히스토리

**대표 이벤트 예시**

- `DB FILE SEQUENTIAL READ`  
  - 인덱스 기반 테이블 액세스 시 디스크 블록 요청 시 발생
